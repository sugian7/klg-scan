<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KLG Scanner</title>
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
body { font-family: Arial; margin: 0; background: #000; }
#video { width: 100%; }
#overlay {
  position:absolute; border:3px dashed #0f0;
  width:70%; height:20%; left:15%; top:60%;
}
#panel { background:#fff; padding:12px; }
button { padding:12px; margin-top:10px; width:100%; }
.label { font-weight:bold; }
</style>
</head>
<body>

<div id="scanMode">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
  <div id="panel">Arahkan nomor layanan ke dalam kotakâ€¦</div>
</div>

<div id="verifyMode" style="display:none; background:#fff; padding:16px;">
  <div><span class="label">Nama:</span> <span id="vNama"></span></div>
  <div><span class="label">Nomor Layanan:</span> <span id="vNomor"></span></div>
  <div><span class="label">Kelurahan:</span> <span id="vKel"></span></div>
  <div><span class="label">Kecamatan:</span> <span id="vKec"></span></div>
  <div><span class="label">Kota:</span> <span id="vKota"></span></div>

  <button onclick="ubahStatus()">UBAH STATUS</button>
  <button onclick="kembali()">KEMBALI</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let worker, foundMeta = null;

const API_URL =
"https://script.google.com/macros/s/AKfycbzRKxzaQlDziui3loYrLWlUk4bywg-iHEUJwcAzu-IBuUFEUHCC3vZM9W379wphKNVMwg/exec";

// Kamera
navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} })
  .then(s => video.srcObject = s);

// OCR
(async()=>{
  worker = await Tesseract.createWorker();
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
})();

// Auto scan
setInterval(async ()=>{
  if (!video.videoWidth || foundMeta) return;

  const w = video.videoWidth, h = video.videoHeight;
  canvas.width = w*0.7; canvas.height = h*0.2;
  ctx.drawImage(video, w*0.15, h*0.6, w*0.7, h*0.2, 0,0,canvas.width,canvas.height);

  const { data:{text} } = await worker.recognize(canvas);
  const digits = text.replace(/\D/g,"");
  const match = digits.match(/114102\d{9}/);
  if (!match) return;

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`action=scan&nomor=${encodeURIComponent(match[0])}`
  })
  .then(r=>r.json())
  .then(j=>{
    if (!j.found) return;
    foundMeta = j;
    tampilkan(j);
  });
}, 600);

function tampilkan(j){
  scanMode.style.display="none";
  verifyMode.style.display="block";
  vNama.textContent = j.data.nama || "-";
  vNomor.textContent = j.data.nomor_layanan || "-";
  vKel.textContent = j.data.kelurahan || "-";
  vKec.textContent = j.data.kecamatan || "-";
  vKota.textContent = j.data.kota || "-";
}

function ubahStatus(){
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`action=update&sheet=${foundMeta.sheet}&row=${foundMeta.row}`
  })
  .then(()=>alert("Status berhasil diubah"));
}

function kembali(){
  foundMeta = null;
  verifyMode.style.display="none";
  scanMode.style.display="block";
}
</script>

</body>
</html>
