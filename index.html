<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KLG Scanner</title>

<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<style>
body { margin:0; font-family:Arial; background:#000; }
#video { width:100%; }
#overlay {
  position:absolute;
  border:3px dashed #00ff00;
  border-radius:8px;
  width:70%;
  height:16%;
  left:15%;
  top:52%;
  pointer-events:none;
}
#panel {
  background:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}
button {
  width:100%;
  padding:14px;
  font-size:16px;
  margin-top:8px;
}
#verifyMode {
  display:none;
  background:#fff;
  padding:16px;
}
.label { font-weight:bold; }
</style>
</head>

<body>

<div id="scanMode">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
  <div id="panel">Arahkan nomor layanan ke dalam kotak</div>
  <button onclick="ambilFoto()">ðŸ“¸ AMBIL FOTO</button>
</div>

<div id="verifyMode">
  <div><span class="label">Nama:</span> <span id="vNama">-</span></div>
  <div><span class="label">Nomor Layanan:</span> <span id="vNomor">-</span></div>
  <div><span class="label">Kelurahan:</span> <span id="vKel">-</span></div>
  <div><span class="label">Kecamatan:</span> <span id="vKec">-</span></div>
  <div><span class="label">Kota:</span> <span id="vKota">-</span></div>

  <button onclick="ubahStatus()">UBAH STATUS</button>
  <button onclick="kembali()">KEMBALI</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzRKxzaQlDziui3loYrLWlUk4bywg-iHEUJwcAzu-IBuUFEUHCC3vZM9W379wphKNVMwg/exec";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const panel = document.getElementById("panel");

let worker;
let foundMeta = null;

// Kamera
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
});

// OCR
(async function initOCR(){
  worker = await Tesseract.createWorker({ logger: function(){} });
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
})();

async function ambilFoto(){
  panel.innerText = "ðŸ“– Membaca nomor layananâ€¦";

  const w = video.videoWidth;
  const h = video.videoHeight;

  canvas.width  = w * 0.7;
  canvas.height = h * 0.16;

  ctx.drawImage(
    video,
    w * 0.15,
    h * 0.52,
    w * 0.7,
    h * 0.16,
    0, 0,
    canvas.width,
    canvas.height
  );

  const result = await worker.recognize(canvas);
  const digits = result.data.text.replace(/\D/g, "");
  const match = digits.match(/114102\d{9}/);

  if (!match) {
    panel.innerText = "âŒ Nomor tidak terbaca. Coba ulang.";
    return;
  }

  panel.innerText = "â³ Mengirim ke sistemâ€¦";

  const options = {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "action=scan&nomor=" + encodeURIComponent(match[0])
  };

  fetch(API_URL, options)
    .then(res => res.json())
    .then(data => {
      if (!data.found) {
        panel.innerText = "âŒ Nomor tidak ditemukan";
        return;
      }
      foundMeta = data;
      tampilkan(data);
    });
}

function tampilkan(d){
  scanMode.style.display = "none";
  verifyMode.style.display = "block";

  vNama.textContent  = d.data.nama || "-";
  vNomor.textContent = d.data.nomor_layanan || "-";
  vKel.textContent   = d.data.kelurahan || "-";
  vKec.textContent   = d.data.kecamatan || "-";
  vKota.textContent  = d.data.kota || "-";
}

function ubahStatus(){
  const options = {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "action=update&sheet=" + encodeURIComponent(foundMeta.sheet) +
          "&row=" + encodeURIComponent(foundMeta.row)
  };

  fetch(API_URL, options)
    .then(() => alert("âœ… Status berhasil diubah"));
}

function kembali(){
  foundMeta = null;
  verifyMode.style.display = "none";
  scanMode.style.display = "block";
  panel.innerText = "Arahkan nomor layanan ke dalam kotak";
}
</script>

</body>
</html>
