<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KLG Scanner</title>

<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<style>
body { margin:0; font-family:Arial; background:#000; }
#video { width:100%; }
#overlay {
  position:absolute;
  border:3px dashed #00ff00;
  border-radius:8px;
  width:70%;
  height:16%;
  left:15%;
  top:52%;
  pointer-events:none;
}
#panel {
  background:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}
#verifyMode {
  display:none;
  background:#fff;
  padding:16px;
}
.label { font-weight:bold; }
button {
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
}
</style>
</head>

<body>

<!-- MODE SCAN -->
<div id="scanMode">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
  <div id="panel">ðŸŸ¡ Arahkan nomor layanan ke dalam kotakâ€¦</div>
</div>

<!-- MODE VERIFIKASI -->
<div id="verifyMode">
  <div><span class="label">Nama:</span> <span id="vNama">-</span></div>
  <div><span class="label">Nomor Layanan:</span> <span id="vNomor">-</span></div>
  <div><span class="label">Kelurahan:</span> <span id="vKel">-</span></div>
  <div><span class="label">Kecamatan:</span> <span id="vKec">-</span></div>
  <div><span class="label">Kota:</span> <span id="vKota">-</span></div>

  <button onclick="ubahStatus()">UBAH STATUS</button>
  <button onclick="kembali()">KEMBALI</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
/* =====================
   KONFIG
===================== */
const API_URL =
"https://script.google.com/macros/s/AKfycbzRKxzaQlDziui3loYrLWlUk4bywg-iHEUJwcAzu-IBuUFEUHCC3vZM9W379wphKNVMwg/exec";

const SCAN_HISTORY_SIZE = 5;
const STABLE_MIN_HIT = 2;

/* =====================
   INIT
===================== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const panel = document.getElementById("panel");

let worker;
let foundMeta = null;
let scanHistory = [];

// Kamera
navigator.mediaDevices.getUserMedia({
  video: { facingMode:"environment" }
}).then(s => video.srcObject = s);

// OCR
(async()=>{
  worker = await Tesseract.createWorker({ logger:()=>{} });
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
})();

/* =====================
   AUTO SCAN
===================== */
setInterval(async()=>{
  if (!video.videoWidth || !worker || foundMeta) return;

  const w = video.videoWidth;
  const h = video.videoHeight;

  canvas.width  = w * 0.7;
  canvas.height = h * 0.16;

  ctx.drawImage(
    video,
    w * 0.15,
    h * 0.52,
    w * 0.7,
    h * 0.16,
    0,0,
    canvas.width,
    canvas.height
  );

  const { data:{ text } } = await worker.recognize(canvas);
  const digits = text.replace(/\D/g,"");
  const match = digits.match(/114102\d{9}/);

  if (!match) {
    panel.innerText = "ðŸŸ¡ Arahkan nomor layanan ke dalam kotakâ€¦";
    scanHistory = [];
    return;
  }

  scanHistory.push(match[0]);
  if (scanHistory.length > SCAN_HISTORY_SIZE) {
    scanHistory.shift();
  }

  panel.innerText = "ðŸŸ¢ Membacaâ€¦";

  const freq = {};
  scanHistory.forEach(n => freq[n] = (freq[n]||0)+1);

  const stableNumber = Object.keys(freq)
    .find(k => freq[k] >= STABLE_MIN_HIT);

  if (!stableNumber) return;

  panel.innerText = "â³ Mengirim ke sistemâ€¦";

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`action=scan&nomor=${encodeURIComponent(stableNumber)}`
  })
  .then(r=>r.json())
  .then(d=>{
    if (!d.found) {
      panel.innerText = "âŒ Nomor tidak ditemukan";
      scanHistory = [];
      return;
    }
    foundMeta = d;
    tampilkanData(d);
  });

}, 800);

/* =====================
   UI
===================== */
function tampilkanData(d){
  scanMode.style.display="none";
  verifyMode.style.display="block";

  vNama.textContent  = d.data.nama || "-";
  vNomor.textContent = d.data.nomor_layanan || "-";
  vKel.textContent   = d.data.kelurahan || "-";
  vKec.textContent   = d.data.kecamatan || "-";
  vKota.textContent  = d.data.kota || "-";
}

function ubahStatus(){
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`action=update&sheet=${foundMeta.sheet}&row=${foundMeta.row}`
  })
  .then(()=>alert("âœ… Status berhasil diubah"));
}

function kembali(){
  foundMeta = null;
  scanHistory = [];
  verifyMode.style.display="none";
  scanMode.style.display="block";
  panel.innerText = "ðŸŸ¡ Arahkan nomor layanan ke dalam kotakâ€¦";
}
</script>

</body>
</html>
