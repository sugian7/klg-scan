<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scan Nomor Layanan KLG</title>

<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<style>
body { font-family: Arial; padding: 12px; }
video { width: 100%; border: 1px solid #ccc; }
button { width: 100%; padding: 14px; margin-top: 8px; font-size: 16px; }
#panel { margin-top: 12px; background: #f5f5f5; padding: 12px; }
</style>
</head>
<body>

<h3>Scan Nomor Layanan KLG</h3>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<button onclick="ambilFoto()">ğŸ“¸ Ambil Foto</button>
<button onclick="scan()">ğŸ” Scan</button>

<div id="panel"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const panel = document.getElementById("panel");

let worker;
let foundMeta = null;

// ===== KAMERA =====
navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } })
.then(s => video.srcObject = s);

// ===== OCR =====
(async()=>{
  worker = await Tesseract.createWorker();
  await worker.loadLanguage("eng");
  await worker.initialize("eng");
})();

function ambilFoto(){
  const w = video.videoWidth;
  const h = video.videoHeight;

  canvas.width = w * 0.6;
  canvas.height = h * 0.35;

  ctx.drawImage(video, w*0.35, h*0.5, w*0.6, h*0.35, 0,0, canvas.width, canvas.height);
  panel.innerText = "ğŸ“¸ Foto diambil";
}

async function scan(){
  panel.innerText = "ğŸ”„ Membaca...";
  const { data:{ text }} = await worker.recognize(canvas);

  const angka = text.replace(/\D/g,"");
  const match = angka.match(/114102\d{9}/);

  if(!match){
    panel.innerText = "âŒ Nomor tidak valid\n\nOCR:\n"+text;
    return;
  }

  const nomor = match[0];

  fetch("PASTE_URL_WEBAPP_KAMU",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:"action=scan&nomor="+encodeURIComponent(nomor)
  })
  .then(r=>r.json())
  .then(showData);
}

function showData(r){
  if(!r.found){
    panel.innerText="âŒ Nomor tidak ditemukan";
    return;
  }

  foundMeta = r;

  panel.innerHTML = `
<b>Nama:</b> ${r.nama}<br>
<b>Nomor:</b> ${r.nomor}<br>
<b>Kelurahan:</b> ${r.kelurahan}<br>
<b>Kecamatan:</b> ${r.kecamatan}<br>
<b>Kota:</b> ${r.kota}<br><br>

<button onclick="ubahStatus()">âœ… Ubah Status</button>
<button onclick="reset()">ğŸ”„ Kembali</button>
`;
}

function ubahStatus(){
  fetch("PASTE_URL_WEBAPP_KAMU",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`action=update&sheet=${foundMeta.sheet}&row=${foundMeta.row}`
  })
  .then(()=>panel.innerText="âœ… Status berhasil diubah");
}

function reset(){
  panel.innerText="";
  foundMeta=null;
}
</script>

</body>
</html>
